<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๊ทธ๋์์ฌ์ฃผ์ํ์ฌ</title>
</head>
<body>
    <h1 onclick="logo()">๊ทธ๋์์ฌ์ฃผ์ํ์ฌ</h1> <p id="login">๋ก๊ทธ์ธ</p> <p id="logout">๋ก๊ทธ์์</p>
    <ul id="postList"></ul>
    <a id="wr" href="writing.html" style="text-align: right;"><p>๊ธ์ฐ๊ธฐ</p></a>
</body>
<script type="module">
    import "./logo.js";
    import { auth } from "./auth.js";
    import { onAuthStateChanged } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { logout } from "./auth.js";
    import { db } from "./app.js";
    import { getDocs, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const inbtn = document.getElementById("login");
    const outbtn = document.getElementById("logout");

    inbtn.style.display = "none";
    outbtn.style.display = "none";

    onAuthStateChanged(auth, user => {
        if (user) {
            outbtn.style.display = "block";
            inbtn.style.display = "none";
        } else {
            outbtn.style.display = "none";
            inbtn.style.display = "block";
        }
    });

    inbtn.addEventListener("click", () => {
        location.href = "https://treepot12.github.io/greatsune/login.html";
    });

    outbtn.addEventListener("click", async() => {
        await logout();
        location.reload();
    });

    document.getElementById("wr").addEventListener("click", (e) => {
        if (!auth.currentUser) {
            alert("๋ก๊ทธ์ธ์ด ํ์ํ ์๋น์ค์๋๋ค!");
            e.preventDefault();
        }
    });

    const q = query(
        collection(db, "posts"),
        orderBy("createdAt", "desc")
    );

    const list = document.getElementById("postList");

    const snapshot = await getDocs(q);
    snapshot.forEach(doc => {
        const { title, content, files = [] } = doc.data();

        const li = document.createElement("li");

        const fileLinks = files.map(file => `
            <div>
            <a href="${file.url}" target="_blank" download="${file.name}">
                ๐ ${file.name}
            </a>
            </div>
        `).join("");

        li.innerHTML = `
            <h3>${title}</h3>
            <p>${content}</p>
            ${fileLinks}
        `;

        list.appendChild(li);
    });

</script>
</html>